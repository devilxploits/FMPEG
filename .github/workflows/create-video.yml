name: ğŸ¬ Create Video

on:
  repository_dispatch:
    types: [create_video]

jobs:
  create-video:
    runs-on: ubuntu-latest

    container:
      image: docker.io/cashewin/video-tools:latest
      credentials:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      options: --user 0

    defaults:
      run:
        shell: bash

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Prepare assets from payload
        run: |
          set -euo pipefail
          mkdir -p assets output /tmp

          echo "================================================"
          echo "ğŸ¬ VIDEO CREATION STARTING (Docker Mode)"
          echo "================================================"

          echo '${{ toJson(github.event.client_payload.images) }}' > /tmp/images.json

          idx=0
          while IFS= read -r image_url; do
            if [ -n "$image_url" ] && [ "$image_url" != "null" ]; then
              outfile="assets/image_$(printf '%03d' "$idx").png"
              echo "ğŸ“¥ Downloading image $((idx + 1)): $image_url"
              curl -L --fail --retry 3 -o "$outfile" "$image_url"
              idx=$((idx + 1))
            fi
          done < <(jq -r '.[]?' /tmp/images.json)

          echo "ğŸ“Š Total images: $idx"
          ls -lh assets/

          if [ -n "${{ github.event.client_payload.voiceover_url || '' }}" ]; then
            echo "ğŸ¤ Downloading voiceover..."
            curl -L -o assets/voiceover.mp3 "${{ github.event.client_payload.voiceover_url }}"
          fi

          if [ -n "${{ github.event.client_payload.background_music_url || '' }}" ]; then
            echo "ğŸµ Downloading background music..."
            curl -L -o assets/bgmusic.mp3 "${{ github.event.client_payload.background_music_url }}"
          fi

      - name: ğŸï¸ Create video with FFmpeg
        run: |
          set -euo pipefail
          
          DURATION=${{ github.event.client_payload.duration || 30 }}
          OUTPUT_NAME=${{ github.event.client_payload.output_name || 'output.mp4' }}

          echo "ğŸ“ Fixing image dimensions (even width/height required by H.264)"
          mkdir -p fixed
          for img in assets/image_*.png; do
            ffmpeg -y -i "$img" -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" "fixed/$(basename "$img")"
          done
          
          cd fixed
          IMG_COUNT=$(ls -1 image_*.png 2>/dev/null | wc -l)
          if [ "$IMG_COUNT" -eq 0 ]; then
            echo "âŒ No images found"
            exit 1
          fi

          echo "ğŸ¬ Creating video from $IMG_COUNT frames..."
          ffmpeg -y -framerate 1 -pattern_type glob -i "image_*.png" \
                 -c:v libx264 -pix_fmt yuv420p -r 30 ../output/temp.mp4

          cd ../output

          if [ -f ../assets/voiceover.mp3 ]; then
            echo "ğŸ§ Adding voiceover..."
            ffmpeg -y -i temp.mp4 -i ../assets/voiceover.mp3 -c:v copy -c:a aac -shortest temp_voice.mp4
            mv temp_voice.mp4 temp.mp4
          fi

          if [ -f ../assets/bgmusic.mp3 ]; then
            echo "ğŸ¼ Mixing background music..."
            ffmpeg -y -i temp.mp4 -i ../assets/bgmusic.mp3 \
              -filter_complex "[1:a]volume=0.4[a];[0:a][a]amix=inputs=2:duration=first" \
              -c:v copy -c:a aac "$OUTPUT_NAME"
          else
            mv temp.mp4 "$OUTPUT_NAME"
          fi

          echo "âœ… Video created successfully: $OUTPUT_NAME"
          ls -lh

      - name: ğŸ“¤ Upload video to backend
        if: success() && github.event.client_payload.callback_url != '' && github.event.client_payload.callback_url != null
        run: |
          echo "================================================"
          echo "ğŸ“¤ UPLOADING VIDEO TO BACKEND"
          echo "================================================"
          
          OUTPUT_NAME=${{ github.event.client_payload.output_name || 'output.mp4' }}
          VIDEO_FILE="output/$OUTPUT_NAME"
          CALLBACK_URL="${{ github.event.client_payload.callback_url }}"
          JOB_ID="${{ github.event.client_payload.job_id }}"
          
          if [ ! -f "$VIDEO_FILE" ]; then
            echo "âŒ Video file not found: $VIDEO_FILE"
            exit 1
          fi
          
          echo "ğŸ“¦ File: $VIDEO_FILE"
          echo "ğŸ”— URL: $CALLBACK_URL"
          echo "ğŸ†” Job: $JOB_ID"
          echo "ğŸ”„ Run: ${{ github.run_id }}"
          echo ""
          
          echo "ğŸ“¡ Uploading video to callback URL..."
          curl -X POST "$CALLBACK_URL" \
               -F "video=@$VIDEO_FILE" \
               -F "status=success" \
               -F "run_id=${{ github.run_id }}" \
               -F "job_id=$JOB_ID" \
               -F "webhook_secret=${{ secrets.WEBHOOK_SECRET }}" \
               --max-time 120 \
               --retry 3 \
               --retry-delay 5 \
               -w "\nğŸ“Š HTTP: %{http_code}\n" \
               -s
          
          echo "âœ… Upload complete"

      - name: ğŸ“¦ Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: final_video
          path: output/*.mp4
          retention-days: 7

      - name: ğŸ”” Send failure notification
        if: failure() && github.event.client_payload.callback_url != '' && github.event.client_payload.callback_url != null
        run: |
          echo "ğŸ“¡ Sending failure notification..."
          
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "{\"status\":\"failed\",\"run_id\":\"${{ github.run_id }}\",\"job_id\":\"${{ github.event.client_payload.job_id }}\",\"error\":\"Video generation failed\",\"webhook_secret\":\"${{ secrets.WEBHOOK_SECRET }}\"}" \
            --max-time 30 \
            --retry 3 \
            -w "\nğŸ“Š HTTP: %{http_code}\n" || echo "âš ï¸ Notification failed"
